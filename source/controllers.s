.IMPORT JOYPAD_1
.IMPORT JOYPAD_2
.IMPORT STROBED_JOYPAD_1
.IMPORT STROBED_JOYPAD_2

.EXPORT READ_CONTROLLERS

.SEGMENT "CDE"
   .PROC READ_CONTROLLERS
   ; initialise the output memory for the joypads
   LDA #1
   STA STROBED_JOYPAD_1
   STA STROBED_JOYPAD_2

   ; send a latch pulse for both controllers
   STA JOYPAD_1
   STA JOYPAD_2
   LDA #0
   STA JOYPAD_1
   STA JOYPAD_2

   ; read the buttons
   STROBE_JOYPAD_1:
   LDA JOYPAD_1
   LSR A
   ROL STROBED_JOYPAD_1
   BCC STROBE_JOYPAD_1

   STROBE_JOYPAD_2:
   LDA JOYPAD_2
   LSR A
   ROL STROBED_JOYPAD_2
   BCC STROBE_JOYPAD_2

   RTS
   .ENDPROC